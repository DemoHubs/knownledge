# HTTPS



**HTTP安全性的不足**

- 明文传递信息，因此通讯内容可能被盗取

- 不验证对方身份，因此可能遭遇伪装

  对于HTTP来说，无论是客户端、服务器，都无法确认通信方，可能无法和预想的通信方进行通信

- 无法证明报文的完整性（完整性指的是信息的准确度）：接收到的内容可能修改

  ![image-20190919223509496](http://ww4.sinaimg.cn/large/006y8mN6gy1g757amodgwj315e0bcwn9.jpg)





##概念

为了保证信息安全，使用SSL或者TLS对信息进行加密。

**HTTPS**指的是HTTP + 加密 + 认证 + 完整性保护

![image-20190919224353810](http://ww3.sinaimg.cn/large/006y8mN6gy1g757jpvn4wj31880lq16k.jpg)

HTTPS并非是一种新协议，只不过HTTP的通信接口部分使用SSL代替了。

通常，HTTP直接和TCP通信，当使用HTTPS的时候，HTTP先和SSL通信，然后SSL再和TCP通信。简而言之，HTTPS就是身披SSL这层外壳的HTTP。

![image-20190919224916551](http://ww3.sinaimg.cn/large/006y8mN6gy1g757pb7iv6j30yc0go42i.jpg)

采用SSL后，HTTP就具有HTTPS的加密、证书、完整性保护的功能。

SSL是独立于HTTP的协议，所以其他协议也可以搭配SSL使用。





##对称加密

发送方和接收方使用同一把钥匙进行加密解密

![image-20190923223942173](http://ww2.sinaimg.cn/large/006y8mN6gy1g79twmq0p6j311w0qyqh9.jpg)

在进行通讯之前，发送方必须把密钥发送给接收方法，然后发送信息，接收方接收到信息之后才能够进行解密。问题就出现在发送密钥这一步。如果密钥被人抓包获取到了，那么别人同样可以破解报文，盗取信息。因此有了非对称加密。



## 非对称加密

非对称加密使用一对非对称的密钥。发送方使用公钥（任何人都可以获得的密钥）进行加密，接收方使用私钥（只有自己拥有的密钥）进行解密。

![image-20190923224449345](http://ww4.sinaimg.cn/large/006y8mN6gy1g79u1wzhzuj31710u01ix.jpg)

非对称解密的通讯流程是这样子的：

- 客户端和服务器建立连接，服务器把公钥发送给客户端
- 客户端使用（服务器的）公钥加密信息，发送给服务器，并且携带了（客户端的）公钥
- 服务器使用（服务器的）私钥解密信息，并且服务器使用（客户端的）公钥加密响应信息
- 客户端使用私钥解密响应信息。



##HTTPS使用的加密方式

非对称加密能解决密钥被盗用的问题，但是对称加密也有它的好处，就是效率更快。那么怎么结合两者的优点呢？HTTPS采用**对称加密和非对称加密结合的方式**。



![image-20190923230634281](http://ww1.sinaimg.cn/large/006y8mN6gy1g79uojrnw0j30ls0ouabf.jpg)

流程如下：

- 客户端从服务器请求得到公钥
- 客户端生成对称加密的**密钥**
- 客户端使用公钥加密**密钥**
- 客户端发送加密过后的**对称密钥**
- 服务器使用私钥解密**密钥**
- 之后，客户端和服务器的所有信息都通过该**密钥**进行加密解密



**采用这种方式为什么会快呢？**

如果采用非对称加密的方式，那么每次请求都需要先请求获取到接收方的公钥。比如仅仅采用非对称加密，那么A发送报文给B，那么A首先得到B的公钥。然后B发送响应给A，那么B首先得到A的公钥。

如果采用混合加密的方式，当第一次请求的时候，使用非对称加密的方式获取到**用于加密解密的密钥**，后面的所有请求就只使用该密钥进行加密、解密。无需再多余的请求获取密钥。很明显，采用混合加密的方式，少了B获取A的公钥的步骤，只需要A获取一次公钥就好了。



### 抓包分析

![image-20191001215926573](https://tva1.sinaimg.cn/large/006y8mN6gy1g7j1p7ga3mj30qe0xgase.jpg)

步骤1：客户端发送Client Hello开始SSL通信，报文中包含客户端支持的SSL版本、加密算法、密钥长度等。

步骤2：服务器如果能进行SSL通信，则以Server Hello作为应答。报文中含有有SSL版本、加密算法、密钥长度。这些内容是从客户端发来的SSL版本、加密算法、密钥长度里面筛选出来的。（也就是筛选出客户端、服务器都支持的SSL版本、加密算法、密钥长度）。

步骤3：服务器发送Certificate报文。报文中包含公开密钥证书。

步骤4：服务器发送Server Hello Done报文通知客户端，最初阶段的SSL握手协商部分结束。

步骤5：SSL第一次握手结束以后，客户端以Client Key Exchange报文作为回应。报文中包含pre-master secret随机密码串。该报文已用步骤3中的公开密钥进行加密。

步骤6：接着客户端发送Change Cipher Spec报文。该报文会提示服务器，后面的通信将使用pre-master secret密匙进行加密。

步骤7：客户端发送Finished报文，该报文包含连接至今全部报文的整体校验值。这次握手协商能否能够成功，要以服务器能否正确解密该报文作为判定标准。

步骤8：服务器同样发送Change Cipher Spec。提示客户端后面的通信将使用pre-master secret进行通讯。

步骤9：服务器发送Finished报文。

步骤10：服务器和客户端的Finished报文交换完毕后，SSL连接就算建立完成了。此处开始进行应用层协议的通讯，即开始进行HTTP请求。

步骤11：应用层进行通讯，即发送HTTP请求、响应

步骤12：最后由客户端想断开连接时，发送close_notify报文。











**HTTPS的缺点**

当使用SSL的时候，进行一些额外的处理，导致速度变慢。

慢的主要原因如下：

- 通信慢
- 消耗CPU和内存等资源

![image-20190925224222031](http://ww1.sinaimg.cn/large/006y8mN6gy1g7c580r5atj315s0nqe0b.jpg)









##证书

由于通讯双方的都可能被伪装（比如HTTPS采用混合加密的方法，但是第一步客户端获取公钥，该公钥可能是被攻击者替换掉的公钥），为了验证通讯双方的身份，采取了**证书**。

证书由值得信任的第三方机构颁发，用于证明服务器或者客户端是真实存在的。

另外伪造证书非常困难，所以只要通讯双方持有证书，基本就认为身份不存在问题。

![image-20190919223243555](http://ww3.sinaimg.cn/large/006y8mN6gy1g757855t9hj315t0u0nn5.jpg)

**证书是怎么解决上述公钥被替换的问题呢？**

首先服务器的运营人员想证书机构申请证书，证书机构判定真实性后，将公钥做数字签名，并且证书和公钥绑定在一起，也就是**公钥证书（又称为数字证书）**。服务器会将该公钥证书发给客户端。客户端就通过**认证机构的公开密钥**，对这张证书上面的数字签名进行校验，如果认证通过，那么服务器的公开密钥就是值得信赖的。

![image-20190923232535539](http://ww3.sinaimg.cn/large/006y8mN6gy1g79v8drjg2j31340u0hdt.jpg)



**认证机构的公钥如何安全的给客户端？**

多数浏览器会内置认证机构的公开密钥



**EV SSL证书**

EV SSL证书用于确认证书对应的企业是否真实存在。



**客户端证书**

用于确认进行通讯的客户端是预料之内的客户端。服务器对应的企业需要为客户端购买证书，客户端安装该证书。然后在请求的时候使用该证书来证明自己的身份。一般用于网上银行。





## 扩展

### 中间人攻击

指的是 请求或者响应在传输过程中，被拦截并且篡改。

![image-20190919223851806](http://ww2.sinaimg.cn/large/006y8mN6gy1g757eh6pwcj30yg0m0ndu.jpg)

使用HTTPS提供完整性保护，可以解决中间人攻击。