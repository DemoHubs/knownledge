# TCP



##概述

TCP是一种可靠的，面向连接，基于字节流，全双工的协议。

![image-20191001132756993](https://tva1.sinaimg.cn/large/006y8mN6gy1g7imwypvvvj313y0ikwnb.jpg)



###面向连接

为什么说TCP是面向连接的协议呢？因为TCP在正式通讯之前，会使用三次握手建立逻辑连接；在通讯结束时，使用四次挥手断开连接。



###可靠的

可靠指的是TCP协议保证传输的可靠性，主要有：

- 对每个包提供校验和
- **包的序列号解决了接收数据乱序、重复问题**
- **超时重传**
- 流量控制
- 拥塞控制



####校验和

每个TCP包首部中都有2个字节表示校验和，用于防止在传输过程中数据包有损坏。如果收到一个校验和有差错的数据包，TCP不会发送任何确认，直接抛弃它，等待发送端重传。

![image-20191001130838282](https://tva1.sinaimg.cn/large/006y8mN6gy1g7imnv68y6j312i0bi43e.jpg)



####包的序列号解决乱序、重复问题

假如发送端向TCP套接字中写入3000字节的数据，TCP把这批数据分为3个TCP包发送，分别为[1, 1000],  [1001, 2000],  [2001, 3000]字节。

现在由于网络原因，导致第二、三个包先到了，TCP不会因此搞混（把第二个包当做第一个包），它会等待第一个包，然后根据序号将这些包进行重排序，然后才提交给应用层。

如果由于网络原因，收到重复的包，TCP会根据序号判断包重复了，丢弃多余的包。

![image-20191001131650383](https://tva1.sinaimg.cn/large/006y8mN6gy1g7imnoul10j312g0e6tdk.jpg)





####超时重传

TCP发送数据后会启动一个定时器，如果在指定时间内没有收到ACK确认，就会重新发送该数据包



####拥塞控制、流量控制





###面向字节流

TCP是面向字节流的协议。流的含义是没有固定的报文边界。





###全双工协议

通信双方在任意时刻既可以发送数据，也可以接收数据。每个方向的数据流都独立管理序列号、滑动窗口大小、MSS等信息。



## 最大传输单元

![image-20191002152353936](https://tva1.sinaimg.cn/large/006y8mN6gy1g7jvvy1uatj30ym0bq78a.jpg)



**数据链路层**能够传输的帧大小是有限制的，这个大小限制叫做**最大传输单元（MTU）**



下图是以太网的帧格式，以太网的帧最小的帧是 64 字节，除去 14 字节头部和 4 字节 CRC 字段，有效荷载最小为 46 字节。最大的帧是 1518 字节，除去 14 字节头部和 4 字节 CRC，有效荷载最大为 1500，这个值就是以太网的 MTU。因此如果传输 100KB 的数据，至少需要 （100 * 1024 / 1500) = 69 个以太网帧。

![image-20191002152727220](https://tva1.sinaimg.cn/large/006y8mN6gy1g7jvzln4j9j310i094dk1.jpg)

不同的数据链路层的 MTU 是不同的。通过`netstat -i` 可以查看网卡的 mtu，比如在 我的 centos 机器上可以看到

![image-20191002152755165](https://tva1.sinaimg.cn/large/006y8mN6gy1g7jw03cj37j311806on1k.jpg)





### IP分段

IPv4 数据报的最大大小为 65535 字节，这已经远远超过了以太网的 MTU，而且有些网络还会开启巨帧（Jumbo Frame）能达到 9000 字节。

当一个IP数据包大于MTU时，IP会把数据报文切割成多个小片段，每个片段小于MTU，使得这些小的报文可以通过数据链路层进行传输。

![image-20191002153159024](https://tva1.sinaimg.cn/large/006y8mN6gy1g7jw4bk511j30w60bkdkb.jpg)

IP首部中有一个叫做**分片偏移量**的字段，用来表示该分片在原始数据报文中的位置。

![image-20191002153359640](https://tva1.sinaimg.cn/large/006y8mN6gy1g7jw6exymrj311y0aogqw.jpg)

假设MTU是1500，IP分片如下图所示：

![image-20191002153859414](https://tva1.sinaimg.cn/large/006y8mN6gy1g7jwblt1j0j30ui0q67ed.jpg)

offset即**分片偏移量**，more fragment表示后面还有没有分片。



我们知道，IP协议不会对丢包进行重传，那么假如某个片段的包丢了，IP无法组转成完成数据包给上层，那会怎样呢？    这时候，就取决于传输层是否进行重传。

利用 IP 包分片的策略，有一种对应的网络攻击方式`IP fragment attack`，就是一直传`More fragments = 1`的包，导致接收方一直缓存分片，从而可能导致接收方内存耗尽。



### 路径MTU

一个包从发送端到接收端，可能经过很多个网络，每个网络的MTU都不一样，其中最小的MTU称为**路径MTU**。

![image-20191002154632949](https://tva1.sinaimg.cn/large/006y8mN6gy1g7jwjh4986j312e0eq7b4.jpg)

路径 MTU 就跟木桶效应是一个道理，木桶的盛水量由最短的那条短板决定，**路径 MTU**也是由通信链条中最小的 MTU 决定。

















## 套接字

TCP连接的端点叫做套接字（Socket）。它由IP和端口号构成。每一条TCP连接唯一的被通讯的两个端点确定。





## 相关协议



### 滑动窗口协议

- 采用停止等待协议可能会导致信道利用率非常低，为了提高传输效率，需要使用流水线传输。也就是说发送方可以连续发送多个分组，不必每发完一个分组就停下来等待对方的确认。这样可以使信道上一直有数据不间断的在传送。这被称为连续ARQ协议或滑动窗口协议。它比较复杂但却是TCP协议的精髓。

- 所谓的滑动窗口就是说位于此窗口内的分组可以被连续的发送出去，而不需要等待对方的确认。假设此时1-5个分组位于发送窗口内，这5个分组就会被连续的发送出去。当发送方收到第一个分组的确认后，就会向后移动一个分组的位置，此时就可以发送第6个分组了。接收方一般采用累积确认的方式。也就是说，接收方不必对收到的每个分组逐个发送确认，而是可以收到几个分组后，对按序到达的最后一个分组发送确认。这样就表示到这个分组为止的所有分组都被正确接收。如果此时发送方发送了前5个分组，而第3个分组丢失了，这是接收方只能对前两个分组发送确认。发送方不知道后面3个分组的下落。实际上仅仅第3个分组没有收到，但是发送方仍然会发送后三个分组。



### 停止等待协议

- TCP发送的报文段是交付给IP层传送的，但IP层只提供尽最大努力交付。也就是说TCP下面的网路所提供的是不可靠的服务。可靠传输必须依靠TCP来实现。停止等待协议就是一种方式。

- 停止等待协议就是每发送完一个分组就停止发送，等待对方确认，在收到确认后再传送下一个分组。如果发送方在一段时间后仍然没有收到确认，就认为刚刚发送的分组丢失了，因而重传前面发送过的分组，这被称为超时重传。要实现超时重传，就要在每发送完一个分组后设置一个超时计时器。如果在超时计时器到期之前收到了对方的确认，就撤销已设置的超时计时器。因此发送方在发送一个分组之后，必须暂时保存已发送的分组的副本。只有在收到响应的确认后才能清除暂时保留的分组的副本。分组和确认分组都必须进行编号，这样才能知道哪一个发送过的数据已被确认。

- 如果发送方发送了数据之后，在超时时间内没有收到接收方的确认，它会重传数据。如果此时接受方再次接收到此数据，它就会将此数据丢弃，并向发送方发送确认。发送方没有收到确认，可能是因为接收方的确认出错或丢失。发送方还可能收到重复的确认，对待重复的确认只需要丢弃即可。上述可靠的传输协议被称为**自动重传请求ARQ**。