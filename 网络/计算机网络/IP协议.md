# IP协议



## 概述

IP协议是TCP/IP族中最核心的协议。 所有的TCP、UDP、ICMP都以IP数据报格式传输。

它的特点有：

- 不可靠：它不保证IP数据报能成功到达目的地。如果发生某种错误时，比如说某个路由器暂时用完了缓冲区，IP协议有一个简单的错误处理算法：丢弃该数据报，然后发送ICMP数据报给发送端。  任何要求的可靠性必须由上层来提供（如TCP）。
- 无连接：IP协议不维护任何数据报的状态信息。每个数据报的处理是独立的。这也说明，IP数据报可以不按发送顺序接收。如果一个发送端向同一个接收端连续发送2个IP数据报，分别是数据报A、B，每个数据报都是独立的进行路由选择，可能选择不同的路线，因此B可能在A之前先达到。





## IP首部

![image-20200516130452305](https://tva1.sinaimg.cn/large/007S8ZIlgy1geu7j92vvwj312k0pen1x.jpg)

分析图3-1中的首部，最高位在左边，记为0bit；最低位在右边，记为31bit。

- 版本号：目前协议版本号是4，因此IP有时候也称为IPv4。
- 首部长度：标识了IP数据报首部的长度。普通IP数据报（没有任何选项）的字段值是5。
- 服务类型：包括3 bit的优先权字段（取值可以从000-111所有值），4 bit的TOS子字段分别代表：最小时延、最大吞吐量、最高可靠性和最小费用。4 bit中只能置其中1 bit。如果所有4 bit均为0，那么就意味着是一般服务，1 bit未用位但必须置0。简单来说代表优先级，例如语音数据优先或者视频流优先等等。
- 总长度：指的是整个IP数据报的长度。以字节为单位。
  - 利用总长度字段和首部长度字段，就可以知道IP数据报内容的起始位置和长度。由于该字段占16bit，所以IP数据报最长可达65535字节。
  - 总长度字段是IP首部中必要的内容，因为一些数据链路需要填充一些数据已达到最小长度，比如说以太网的最小长度为46字节，但是IP数据报可能更短，这时候就要进行填充数据。如果没有总长度字段，那么IP层就不知道46字节中有多少是IP数据报的内容。
- 标识字段：唯一的标识主机发送的每一份数据报。通常没发送一份报文它的值就会加1。
- TTL生成时间字段：设置了数据报最多可以经过的路由器数。TTL的初始值由源主机设置，通常为32或64。一旦经过一个处理它的路由器，该值就会减1。当该值为0的时候，数据报就会被丢弃，并发送ICMP报文通知源主机。
- 协议字段：TCP可以传递数据给IP，UDP也可以。那么IP就用协议字段来表示该数据报是哪个协议传递给IP的。那么在IP对数据报进行分用的时候，就可以把数据报传递给正确的上层协议。
- 首部校验和字段：是根据IP首部计算的校验和码，它不对首部后面的数据进行计算。接收方利用该字段来判断传输过程中首部是否发生了变化。如果校验和错误，那么IP就丢弃数据报，但是不生成ICMP报文，由上层发现丢失的数据报并进行重传。
- 源IP和目的IP地址字段
- 选项字段：是数据报中可变长的可选信息。比如说时间戳等。

